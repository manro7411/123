/* eslint-disable @typescript-eslint/no-explicit-any */
import { useContext, useEffect, useState } from "react";
import { createPortal } from "react-dom";
import { X, Save, Plus, Trash2 } from "lucide-react";
import { TARGET_OPTION } from "../AdminUtil";
import type { QuestionForm } from "../../../types/trainer/types";
import { AuthContext } from "../../../Authentication/AuthContext";

export interface Lesson {
  id: number | string;
  title: string;
  thumbnailUrl?: string;
  category: string;
  description: string;
  contentType: "video" | "document";
  assignType: "all" | "team" | "specific";
  quizAvailable?: boolean;
}

interface EditLessonModalProps {
  open: boolean;
  initial: Lesson;
  onClose: () => void;
  onSave: (data: {
    title: string;
    category: string;
    description: string;
    thumbnailUrl?: string;
    video?: File | null;
    contentType: "video" | "document";
    assignType: "all" | "team" | "specific";
    quizAvailable: boolean;
    questions?: QuestionForm[];
  }) => Promise<void> | void;
}

type Choice = { choiceId?: string; text: string; correct?: boolean };
type Q = { questionId?: string; questionText: string; choices: Choice[]; isCorrect?: boolean };

const emptyChoice = (): Choice => ({ text: "", correct: false });
const emptyQuestion = (): Q => ({ questionText: "", choices: [emptyChoice(), emptyChoice()] });

const EditLessonModal = ({ open, initial, onClose, onSave }: EditLessonModalProps) => {
  const { token } = useContext(AuthContext);

  const [title, setTitle] = useState(initial.title);
  const [category, setCategory] = useState(initial.category);
  const [description, setDescription] = useState(initial.description);
  const [thumbnailUrl, setThumbnailUrl] = useState(initial.thumbnailUrl ?? "");
  const [videoFile, setVideoFile] = useState<File | null>(null);
  const [contentType, setContentType] = useState<"video" | "document">("video");
  const [assignType, setAssignType] = useState<"all" | "specific" | "team">("all");
  const [saving, setSaving] = useState(false);
  const [quizAvailable, setQuizAvailable] = useState(initial.quizAvailable ?? false);
  const [questions, setQuestions] = useState<Q[]>([]);
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    // reset when initial changes
    setTitle(initial.title);
    setCategory(initial.category);
    setDescription(initial.description);
    setThumbnailUrl(initial.thumbnailUrl ?? "");
    setContentType(initial.contentType ?? "video");
    setAssignType(initial.assignType ?? "all");
    setQuizAvailable(initial.quizAvailable ?? false);
    setQuestions([]);
  }, [initial]);

  useEffect(() => {
    if (!open) return;

    const fetchLessonDetails = async () => {
      if (!initial?.id) return;
      setLoading(true);
      try {
        const url = `/api/learning/${encodeURIComponent(String(initial.id))}`;
        console.log("EditLessonModal: requesting", url);
        const res = await fetch(url, {
          headers: token ? { Authorization: `Bearer ${token}` } : undefined,
          cache: "no-store",
        });
        console.log("EditLessonModal: response status:", res.status);
        if (!res.ok) {
          const text = await res.text().catch(() => "");
          console.error("EditLessonModal: fetch failed:", res.status, text);
          setLoading(false);
          return;
        }
        const data = await res.json();
        console.log("EditLessonModal: fetched lesson details:", data);

        setTitle(data.title ?? "");
        setCategory(data.category ?? "");
        setDescription(data.description ?? "");
        setThumbnailUrl(data.thumbnailUrl ?? "");
        setContentType((data.contentType ?? "video").toLowerCase() === "document" ? "document" : "video");
        setAssignType(data.assignType ?? "all");
        setQuizAvailable(Boolean(data.quizAvailable));

        // normalize questions from backend
        const qs: Q[] = Array.isArray(data.questions)
          ? data.questions.map((q: any) => ({
              questionId: q.questionId ?? q.id,
              questionText: q.questionText ?? q.text ?? q.title ?? "",
              choices: Array.isArray(q.choices)
                ? q.choices.map((c: any) => ({
                    choiceId: c.choiceId ?? c.id,
                    text: c.text ?? "",
                    correct: Boolean(c.correct ?? c.isCorrect ?? false),
                  }))
                : [emptyChoice(), emptyChoice()],
              isCorrect: q.isCorrect ?? undefined,
            }))
          : [];

        setQuestions(qs.length ? qs : [emptyQuestion()]);
      } catch (error) {
        console.error("Failed to fetch lesson details:", error);
      } finally {
        setLoading(false);
      }
    };

    fetchLessonDetails();
  }, [open, initial.id, token]);

  const addQuestion = () => setQuestions((s) => [...s, emptyQuestion()]);
  const removeQuestion = (idx: number) => setQuestions((s) => s.filter((_, i) => i !== idx));
  const updateQuestionText = (idx: number, text: string) =>
    setQuestions((s) => s.map((q, i) => (i === idx ? { ...q, questionText: text } : q)));

  const addChoice = (qIdx: number) =>
    setQuestions((s) => s.map((q, i) => (i === qIdx ? { ...q, choices: [...q.choices, emptyChoice()] } : q)));

  const removeChoice = (qIdx: number, cIdx: number) =>
    setQuestions((s) =>
      s.map((q, i) => (i === qIdx ? { ...q, choices: q.choices.filter((_, ci) => ci !== cIdx) } : q))
    );

  const updateChoiceText = (qIdx: number, cIdx: number, text: string) =>
    setQuestions((s) =>
      s.map((q, i) => (i === qIdx ? { ...q, choices: q.choices.map((c, ci) => (ci === cIdx ? { ...c, text } : c)) } : q))
    );

  const toggleChoiceCorrect = (qIdx: number, cIdx: number) =>
    setQuestions((s) =>
      s.map((q, i) =>
        i === qIdx
          ? {
              ...q,
              choices: q.choices.map((c, ci) => (ci === cIdx ? { ...c, correct: !c.correct } : c)),
            }
          : q
      )
    );

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setSaving(true);
    try {
      const payloadQuestions: QuestionForm[] = questions.map((q) => {
        const options = q.choices.map((c) => ({ choiceId: c.choiceId, text: c.text }));
        const correctAnswers = q.choices
          .map((c, i) => (c.correct ? (c.choiceId ?? String(i)) : null))
          .filter((v): v is string => v !== null);
        const type = correctAnswers.length > 1 ? "multiple" : "single";

        return {
          questionId: q.questionId,
          questionText: q.questionText,
          type,
          options,
          correctAnswers,
        } as unknown as QuestionForm;
      });

      const payload = {
        title: title.trim(),
        category: category.trim(),
        description: description.trim(),
        thumbnailUrl: thumbnailUrl.trim() || undefined,
        video: videoFile,
        contentType,
        assignType: assignType as "all" | "team" | "specific",
        quizAvailable,
        questions: quizAvailable ? payloadQuestions : undefined,
      };

      // log full payload (mask file content)
      const videoMeta = videoFile ? { name: videoFile.name, size: videoFile.size, type: videoFile.type } : null;
      console.log("EditLessonModal: saving payload:", { ...payload, video: videoMeta });

      await onSave(payload);

      console.log("EditLessonModal: save completed for lesson id:", initial.id);
    } catch (err) {
      console.error("EditLessonModal: save failed:", err);
      throw err;
    } finally {
      setSaving(false);
    }
  };

  if (!open) return null;

  const stop = (e: React.MouseEvent) => e.stopPropagation();

  const modal = (
    <div
      className="fixed inset-0 bg-black/50 z-[9999] flex items-center justify-center p-4"
      onClick={onClose}
      aria-modal="true"
      role="dialog"
    >
      <div className="bg-white rounded-xl shadow-xl w-full max-w-3xl p-6 overflow-auto max-h-[90vh]" onClick={stop}>
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-lg font-semibold">Edit Learning Content</h2>
          <button onClick={onClose} className="text-gray-500 hover:text-gray-700" type="button" aria-label="Close">
            <X size={18} />
          </button>
        </div>

        {loading ? (
          <div className="p-6 text-sm text-gray-500">Loading lesson...</div>
        ) : (
          <form className="space-y-4" onSubmit={handleSubmit}>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Thumbnail URL</label>
              <input
                value={thumbnailUrl}
                onChange={(e) => setThumbnailUrl(e.target.value)}
                className="w-full border rounded-lg px-3 py-2"
                placeholder="https://..."
                type="url"
                disabled={saving}
              />
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Title</label>
                <input
                  value={title}
                  onChange={(e) => setTitle(e.target.value)}
                  className="w-full border rounded-lg px-3 py-2"
                  placeholder="Lesson title"
                  required
                  disabled={saving}
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Category</label>
                <input
                  value={category}
                  onChange={(e) => setCategory(e.target.value)}
                  className="w-full border rounded-lg px-3 py-2"
                  placeholder="Category"
                  required
                  disabled={saving}
                />
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
              <textarea
                value={description}
                onChange={(e) => setDescription(e.target.value)}
                className="w-full h-28 border rounded-lg px-3 py-2"
                placeholder="Description"
                required
                disabled={saving}
              />
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Content Type</label>
                <div className="px-3 py-2 border rounded-lg bg-gray-100 text-gray-700">{contentType === "video" ? "Video" : "Document"}</div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Assign Type</label>
                <select
                  value={assignType}
                  onChange={(e) => setAssignType(e.target.value as any)}
                  className="w-full border rounded-lg px-3 py-2"
                  disabled={saving}
                >
                  {TARGET_OPTION["Option"].map((option) => (
                    <option key={option.index} value={option.index}>
                      {option.option}
                    </option>
                  ))}
                </select>
              </div>
            </div>

            {contentType === "video" && (
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Upload Video</label>
                <input
                  type="file"
                  accept="video/*"
                  onChange={(e) => {
                    const file = e.target.files?.[0];
                    if (file) setVideoFile(file);
                  }}
                  disabled={saving}
                  className="w-full border rounded-lg px-3 py-2"
                />
              </div>
            )}

            <div className="flex items-center gap-3">
              <label className="flex items-center gap-2">
                <input type="checkbox" checked={quizAvailable} onChange={(e) => setQuizAvailable(e.target.checked)} />
                <span className="text-sm">Quiz available</span>
              </label>
            </div>

            {/* Quiz editor */}
            {quizAvailable && (
              <div className="border rounded-lg p-4 bg-gray-50">
                <div className="flex items-center justify-between mb-3">
                  <h3 className="text-sm font-semibold">Questions</h3>
                  <button type="button" onClick={addQuestion} className="inline-flex items-center gap-2 px-3 py-1 bg-white border rounded text-sm">
                    <Plus size={14} /> Add question
                  </button>
                </div>

                <div className="space-y-4">
                  {questions.map((q, qi) => (
                    <div key={q.questionId ?? qi} className="bg-white border rounded p-3">
                      <div className="flex justify-between items-start gap-3">
                        <div className="flex-1">
                          <label className="text-xs text-gray-500">Question {qi + 1}</label>
                          <input
                            value={q.questionText}
                            onChange={(e) => updateQuestionText(qi, e.target.value)}
                            className="w-full mt-1 border rounded px-2 py-1"
                          />
                        </div>
                        <div className="flex flex-col items-end gap-2">
                          <button type="button" onClick={() => removeQuestion(qi)} className="text-red-500">
                            <Trash2 size={16} />
                          </button>
                        </div>
                      </div>

                      <div className="mt-3 space-y-2">
                        {q.choices.map((c, ci) => (
                          <div key={c.choiceId ?? ci} className="flex items-center gap-2">
                            <button
                              type="button"
                              onClick={() => toggleChoiceCorrect(qi, ci)}
                              className={`px-2 py-1 rounded ${c.correct ? "bg-green-500 text-white" : "bg-gray-200 text-gray-700"}`}
                            >
                              {c.correct ? "✓" : "○"}
                            </button>
                            <input
                              value={c.text}
                              onChange={(e) => updateChoiceText(qi, ci, e.target.value)}
                              className="flex-1 border rounded px-2 py-1"
                            />
                            {q.choices.length > 2 && (
                              <button type="button" onClick={() => removeChoice(qi, ci)} className="text-red-500">
                                <Trash2 size={16} />
                              </button>
                            )}
                          </div>
                        ))}

                        <div>
                          <button type="button" onClick={() => addChoice(qi)} className="mt-2 inline-flex items-center gap-2 px-2 py-1 bg-white border rounded text-sm">
                            <Plus size={12} /> Add choice
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            <div className="flex justify-end gap-3 pt-2">
              <button type="button" onClick={onClose} className="px-4 py-2 rounded-lg border" disabled={saving}>
                Cancel
              </button>
              <button type="submit" className="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 flex items-center gap-2 disabled:opacity-60" disabled={saving}>
                <Save size={16} /> {saving ? "Saving..." : "Save"}
              </button>
            </div>
          </form>
        )}
      </div>
    </div>
  );

  return createPortal(modal, document.body);
};

export default EditLessonModal;
