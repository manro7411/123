package QuizService.DTOs.Response;

import QuizService.DTOs.ChoiceDTO;
import java.util.List;

public class AnswerDetailDTO {
    public String questionId;
    public String questionText;

    // "MULTIPLE" หรือ "FILL_BLANK"
    public String type;

    // สำหรับ MULTIPLE:
    public List<ChoiceDTO> choices;
    public String selectedChoiceId; // choice id ที่เลือก

    // สำหรับ FILL_BLANK:
    public String userAnswer;      // คำตอบที่ user กรอก
    public String correctAnswer;   // เฉลย

    public boolean isCorrect;
}
package QuizService.DTOs.Response;

import java.time.LocalDateTime;
import java.util.List;

public class QuizAttemptDetailDTO {
    public String attemptId;
    public String userEmail;
    public String lessonId;

    public String learningContentTitle;
    public String learningDescription;
    public String learningCategories;

    public Integer score;
    public Integer maxScore;
    public Integer percentScore;

    public Integer attemptCount;
    public Integer max_attempt;

    public LocalDateTime attemptedAt;

    public List<AnswerDetailDTO> answers;
}


package QuizService.Services;

import QuizService.DTOs.ChoiceDTO;
import QuizService.DTOs.Response.AnswerDetailDTO;
import QuizService.DTOs.Response.QuizAttemptDetailDTO;
import QuizService.Entity.QuestionChoiceEntity;
import QuizService.Entity.QuestionEntity;
import QuizService.Entity.QuestionFillBlankEntity;
import QuizService.Entity.QuizAnswerEntity;
import QuizService.Entity.QuizAttemptEntity;
import QuizService.Resources.QuestionType;
import jakarta.enterprise.context.ApplicationScoped;
import jakarta.inject.Inject;
import jakarta.persistence.EntityManager;
import jakarta.ws.rs.NotFoundException;
import model.LearningContent;
import model.UserLessonProgress;

import java.util.ArrayList;
import java.util.List;

@ApplicationScoped
public class QuizServices {

    @Inject
    EntityManager em;

    public QuizAttemptDetailDTO mapAttemptToDTO(QuizAttemptEntity attempt) {
        QuizAttemptDetailDTO dto = new QuizAttemptDetailDTO();

        dto.attemptId = attempt.getId().toString();
        dto.attemptedAt = attempt.getAttemptedAt();
        dto.userEmail = attempt.getUser().getEmail();
        dto.score = attempt.getScore();
        dto.maxScore = attempt.getMaxScore();
        dto.percentScore = (int) Math.round(
                attempt.getScore() * 100.0 / Math.max(attempt.getMaxScore(), 1)
        );

        // lesson / content info
        UserLessonProgress lp = attempt.getLessonProgress();
        if (lp != null) {
            dto.lessonId = lp.getLessonId();
            LearningContent content = em.find(LearningContent.class, lp.getLessonId());
            if (content != null) {
                dto.learningContentTitle = content.getTitle();
                dto.learningDescription = content.getDescription();
                dto.learningCategories = content.getCategory();
                dto.max_attempt = content.getMaxAttempts();
            }
            dto.attemptCount = attemptCount(dto.userEmail, dto.lessonId);
        }

        // ดึงคำตอบทั้งหมดของ attempt นี้
        List<QuizAnswerEntity> answers = em.createQuery("""
                SELECT qa FROM QuizAnswerEntity qa
                JOIN FETCH qa.question q
                WHERE qa.attempt = :attempt
                """, QuizAnswerEntity.class)
                .setParameter("attempt", attempt)
                .getResultList();

        List<AnswerDetailDTO> answerDetails = new ArrayList<>();

        for (QuizAnswerEntity qa : answers) {
            QuestionEntity question = qa.getQuestion();
            if (question == null) continue;

            AnswerDetailDTO a = new AnswerDetailDTO();
            a.questionId = question.getId();
            a.questionText = question.getQuestionText();
            a.type = question.getType() != null ? question.getType().name() : null;

            // MULTIPLE CHOICE
            if (question.getType() == QuestionType.MULTIPLE) {
                a.selectedChoiceId = qa.getSelectedChoiceId();
                a.isCorrect = qa.isCorrect(); // ตรงกับ selectedChoiceId → isCorrect=true

                List<ChoiceDTO> choiceDTOs = new ArrayList<>();
                for (QuestionChoiceEntity c : question.getChoices()) {
                    ChoiceDTO cd = new ChoiceDTO();
                    cd.setChoiceId(c.getId());
                    cd.setText(c.getChoiceText());
                    cd.setCorrect(c.isCorrect());
                    cd.setSelected(c.getId().equals(qa.getSelectedChoiceId()));
                    choiceDTOs.add(cd);
                }
                a.choices = choiceDTOs;
            }

            // FILL IN THE BLANK
            else if (question.getType() == QuestionType.FILL_BLANK) {
                // selectedChoiceId ใน qa = คำตอบที่ user กรอกมา
                String userAnswer = qa.getSelectedChoiceId();
                a.userAnswer = userAnswer;

                String correct = em.createQuery("""
                        SELECT fb.correctAnswer FROM QuestionFillBlankEntity fb
                        WHERE fb.question = :q
                        """, String.class)
                        .setParameter("q", question)
                        .setMaxResults(1)
                        .getResultStream()
                        .findFirst()
                        .orElse(null);

                a.correctAnswer = correct;
                a.isCorrect = (correct != null && userAnswer != null
                        && correct.trim().equalsIgnoreCase(userAnswer.trim()));

                // ไม่จำเป็นต้องมี choices สำหรับ fill blank
                a.choices = null;
            }

            // type อื่น ๆ
            else {
                a.isCorrect = qa.isCorrect();
            }

            answerDetails.add(a);
        }

        dto.answers = answerDetails;
        return dto;
    }

    public int attemptCount(String currentUser, String lessonId) {
        Long attemptCount = em.createQuery("""
                        SELECT COUNT(a) FROM QuizAttemptEntity a
                        WHERE a.user.email = :userEmail AND a.lessonProgress.lessonId = :lessonId
                        """, Long.class)
                .setParameter("userEmail", currentUser)
                .setParameter("lessonId", lessonId)
                .getSingleResult();
        return attemptCount.intValue();
    }

    public int DisplayPercentage(String lessonId, String currentUser) {
        var progress = em.createQuery("""
                        SELECT p FROM UserLessonProgress p
                        WHERE p.lessonId = :lessonId AND p.userEmail = :userEmail
                        """, UserLessonProgress.class)
                .setParameter("lessonId", lessonId)
                .setParameter("userEmail", currentUser)
                .getResultStream()
                .findFirst()
                .orElseThrow(() -> new NotFoundException("No progress found. Please watch the lesson first."));

        return progress.getPercent();
    }
}
{Array.isArray(attempt.answers) &&
  attempt.answers.map((answer: any, idx: number) => {
    const type = (answer.type || "").toUpperCase();

    if (type === "FILL_BLANK") {
      const userAnswer = answer.userAnswer || answer.selectedChoiceId || "";
      const correct = answer.correctAnswer || "";
      const isCorrect = !!answer.isCorrect;

      return (
        <div key={answer.questionId || idx} className="border rounded p-4 bg-white">
          <h4 className="font-semibold text-gray-800 mb-2">
            {idx + 1}. {answer.questionText}
          </h4>
          <p>
            <span className="font-semibold">Your answer: </span>
            <span className={isCorrect ? "text-green-600" : "text-red-600"}>
              {userAnswer || "-"}
            </span>
          </p>
          <p>
            <span className="font-semibold">Correct answer: </span>
            <span className="text-green-700">
              {correct || "-"}
            </span>
          </p>
          <p className="text-xs text-gray-500">
            Result: {isCorrect ? "Correct ✅" : "Incorrect ❌"}
          </p>
        </div>
      );
    }

    // MULTIPLE (เดิม)
    ...
  })}
