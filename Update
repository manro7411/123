/* eslint-disable react-hooks/exhaustive-deps */
import { useContext, useEffect, useState, useMemo } from "react";
import axios from "axios";
import { AuthContext } from "../../../Authentication/AuthContext";
import AdminSidebarWidget from "../Widgets/AdminSideBar";
import { useNavigate } from "react-router-dom";
import { Pencil, Loader2, Trash2 } from "lucide-react";
import EditLessonModal, { type Lesson } from "./EditLessonModal";
import { sendLessonNotification } from "../Widgets/notificationServices";
import { useUserProfile } from "../../User/Lesson/hooks/useUserProfile";
import type { QuestionAnswer, UserProgress } from "../../../types/trainer/types";
import { ENDPOINTS } from "../../../config/endpoints";

// ---------- reusable axios instance ----------
const useAxios = (token?: string) =>
  useMemo(
    () =>
      axios.create({
        headers: token ? { Authorization: `Bearer ${token}` } : undefined,
      }),
    [token]
  );

const AdminTaskManagementPage = () => {
  const { token } = useContext(AuthContext);
  const { email, fullName, avatarUrl } = useUserProfile(token);
  const navigate = useNavigate();

  const api = useAxios(token);

  const [lessons, setLessons] = useState<Lesson[]>([]);
  const [selectedLesson, setSelectedLesson] = useState<Lesson | null>(null);
  const [progressList, setProgressList] = useState<UserProgress[]>([]);
  const [selectedUser, setSelectedUser] = useState<UserProgress | null>(null);
  const [loading, setLoading] = useState(false);
  const [replyLoading, setReplyLoading] = useState(false);
  const [feedback, setFeedback] = useState("");
  const [trainerReply, setTrainerReply] = useState("");
  const [userLessonQuestion, setUserLessonQuestion] = useState<QuestionAnswer[] | undefined>();
  const [showEditModal, setShowEditModal] = useState(false);

  // ---------- helpers ----------
  const fmtDate = (iso?: string) => (iso ? new Date(iso).toLocaleString() : "-");

  // ---------- fetchers ----------
  const fetchLessons = async () => {
    setLoading(true);
    try {
      const { data } = await api.get<Lesson[]>("/api/learning?mine=true");
      setLessons(data);
    } catch (err) {
      console.error("‚ùå Failed to fetch lessons:", err);
      alert("Failed to fetch lessons.");
    } finally {
      setLoading(false);
    }
  };

  const fetchProgress = async (lessonId: string) => {
    try {
      const { data } = await api.get<UserProgress[]>(ENDPOINTS.AlluserProgress);
      const latest = new Map<string, UserProgress>();
      data
        .filter((p) => p.lessonId === lessonId)
        .forEach((p) => latest.set(p.userEmail, p));
      setProgressList([...latest.values()]);
    } catch (err) {
      console.error("‚ùå Failed to fetch progress:", err);
    }
  };

  const fetchUserLessonQuestion = async (userEmail: string, lessonId: string | number) => {
    try {
      const res = await api.get<QuestionAnswer | QuestionAnswer[]>(
        `/api/trainer-question-answer/get-answer-reply-by-question-id/${encodeURIComponent(userEmail)}/${lessonId}`
      );
      const data = res.data;
      setUserLessonQuestion(Array.isArray(data) ? data : data ? [data] : []);
    } catch (err) {
      console.error("‚ùå Failed to fetch user question:", err);
      setUserLessonQuestion([]);
    }
  };

  const fetchUserIdByEmail = async (userEmail: string) => {
    try {
      const res = await api.get("/api/profile/users", { params: { email: userEmail } });
      const users = res.data;
      return Array.isArray(users) && users.length ? users.find((u: any) => u.email === userEmail)?.id ?? null : null;
    } catch (err) {
      console.error("‚ùå Fetch user ID error:", err);
      return null;
    }
  };

  // ---------- effects ----------
  useEffect(() => {
    if (!token) {
      navigate("/");
      return;
    }
    fetchLessons();
  }, [token]);

  useEffect(() => {
    if (selectedUser && selectedLesson) {
      fetchUserLessonQuestion(selectedUser.userEmail, selectedLesson.id);
    } else {
      setUserLessonQuestion(undefined);
    }
  }, [selectedUser, selectedLesson]);

  // ---------- handlers ----------
  const handleSelectLesson = async (lesson: Lesson) => {
    setSelectedLesson(lesson);
    setSelectedUser(null);
    setUserLessonQuestion(undefined);
    await fetchProgress(lesson.id);
  };

  const handleDeleteLesson = async (id: string) => {
    if (!window.confirm("Delete this lesson? This cannot be undone!")) return;
    try {
      await api.delete(`/api/learning/${encodeURIComponent(id)}`);
      setLessons((prev) => prev.filter((l) => String(l.id) !== String(id)));
      if (selectedLesson?.id === id) {
        setSelectedLesson(null);
        setProgressList([]);
        setSelectedUser(null);
      }
      alert("‚úÖ Lesson deleted successfully.");
    } catch (err) {
      console.error("‚ùå Delete failed:", err);
      alert("Failed to delete lesson.");
    }
  };

  const handleSaveLesson = async (data: { title: string; category: string; thumbnailUrl?: string }) => {
    if (!selectedLesson) return;
    try {
      const payload: Lesson = { ...selectedLesson, ...data };
      await api.put(`/api/learning/${selectedLesson.id}`, payload);
      setLessons((prev) => prev.map((l) => (l.id === selectedLesson.id ? payload : l)));
      setSelectedLesson(payload);
      setShowEditModal(false);
      alert("‚úÖ Lesson updated successfully.");
    } catch (err) {
      console.error("‚ùå Update failed:", err);
      alert("Failed to update lesson.");
    }
  };

  // ---------- UI ----------
  if (!token) return null;

  return (
    <div className="min-h-screen bg-gray-50 flex">
      <AdminSidebarWidget />

      <main className="flex-1 p-10 space-y-6">
        <h1 className="text-2xl font-bold text-blue-800 border-b pb-2">üßô Learning Management</h1>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Lesson List */}
          <section className="col-span-1 space-y-4">
            {loading ? (
              <div className="text-center text-gray-500 flex items-center justify-center py-10">
                <Loader2 className="animate-spin mr-2" /> Loading lessons‚Ä¶
              </div>
            ) : (
              lessons.map((lesson) => (
                <div
                  key={lesson.id}
                  className={`relative p-4 rounded-xl shadow border transition-all cursor-pointer ${
                    selectedLesson?.id === lesson.id ? "bg-blue-50 border-blue-500" : "bg-white hover:border-blue-500"
                  }`}
                  onClick={() => handleSelectLesson(lesson)}
                >
                  <h3 className="font-semibold text-lg text-gray-800">{lesson.title}</h3>
                  <p className="text-xs text-purple-600 uppercase">{lesson.category}</p>
                  <p className="text-xs text-gray-500 opacity-60">Click to view details</p>

                  <div className="absolute top-2 right-2 flex gap-2">
                    <button
                      onClick={(e) => {
                        e.stopPropagation();
                        setShowEditModal(true);
                        setSelectedLesson(lesson);
                      }}
                      title="Edit lesson"
                    >
                      <Pencil size={18} className="text-gray-600 hover:text-blue-700" />
                    </button>
                    <button
                      onClick={(e) => {
                        e.stopPropagation();
                        handleDeleteLesson(String(lesson.id));
                      }}
                      title="Delete lesson"
                    >
                      <Trash2 size={18} className="text-red-600 hover:text-red-800" />
                    </button>
                  </div>
                </div>
              ))
            )}
          </section>

          {/* User Progress List */}
          <section className="col-span-1 space-y-3">
            {progressList.length === 0 && selectedLesson && (
              <p className="text-gray-400 text-sm">No progress data yet‚Ä¶</p>
            )}
            {progressList.map((user) => (
              <div
                key={`${user.lessonId}-${user.userEmail}`}
                className={`p-4 rounded-lg shadow border flex justify-between items-center ${
                  selectedUser?.userEmail === user.userEmail ? "bg-blue-50" : "bg-white"
                }`}
              >
                <div>
                  <p className="font-medium text-gray-800">{user.userEmail}</p>
                  <p className="text-xs text-gray-500">{user.percent}% done</p>
                </div>
                <button
                  onClick={() => setSelectedUser(user)}
                  className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm"
                >
                  View
                </button>
              </div>
            ))}
          </section>

          {/* User Overview */}
          <section className="col-span-1 bg-white p-6 rounded-xl shadow">
            <h2 className="text-lg font-semibold mb-4 text-gray-700">User Progress Overview</h2>

            {!selectedUser ? (
              <p className="text-gray-400">‚Üê Select a user to see details</p>
            ) : (
              <div className="space-y-6">
                {/* Quiz History */}
                <button
                  onClick={() => {
                    if (!selectedLesson) return alert("Select a lesson first.");
                    navigate(
                      `/admin/trainer/quiz-history/${encodeURIComponent(String(selectedLesson.id))}/${encodeURIComponent(
                        selectedUser.userEmail
                      )}`
                    );
                  }}
                  className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium shadow"
                >
                  üìú Quiz History
                </button>

                {/* User Info */}
                <div className="flex items-center gap-3">
                  {selectedUser.authorAvatarUrl ? (
                    <img
                      src={selectedUser.authorAvatarUrl}
                      className="w-10 h-10 rounded-full"
                      alt="user avatar"
                    />
                  ) : (
                    <div className="w-10 h-10 bg-gray-200 rounded-full" />
                  )}
                  <div>
                    <p className="font-medium text-gray-800">{selectedUser.userEmail}</p>
                  </div>
                </div>

                {/* Progress */}
                <div>
                  <p className="text-sm text-gray-500">Progress</p>
                  <progress value={selectedUser.percent} max={100} className="w-full h-2 mt-1" />
                  <p className="text-right text-xs text-gray-500">{selectedUser.percent}%</p>
                </div>

                {/* Feedback */}
                {selectedUser.percent === 100 && (
                  <div className="border-t pt-4 space-y-2">
                    <label className="block text-sm font-medium text-gray-700">
                      Feedback for {selectedUser.userEmail}
                    </label>
                    {selectedUser.feedback ? (
                      <div className="p-3 bg-gray-50 border rounded-lg text-sm text-gray-700 whitespace-pre-wrap">
                        {selectedUser.feedback}
                      </div>
                    ) : (
                      <>
                        <textarea
                          value={feedback}
                          onChange={(e) => setFeedback(e.target.value)}
                          className="h-24 w-full border rounded-lg p-2"
                          placeholder="Write your feedback..."
                        />
                        <button
                          onClick={async () => {
                            if (!feedback.trim()) return alert("Feedback cannot be empty.");
                            try {
                              await api.post("/api/user/feedback", {
                                userEmail: selectedUser.userEmail,
                                lessonId: selectedUser.lessonId,
                                feedback,
                                email,
                              });

                              const uid = await fetchUserIdByEmail(selectedUser.userEmail);
                              if (uid) {
                                await sendLessonNotification({
                                  token,
                                  message: `You have received feedback for ${selectedLesson?.title}.`,
                                  userIds: [uid],
                                  target: "USER",
                                });
                              }

                              alert("‚úÖ Feedback sent successfully.");
                              setSelectedUser((u) => (u ? { ...u, feedback } : u));
                              setFeedback("");
                            } catch (err) {
                              console.error("‚ùå Feedback failed:", err);
                              alert("Failed to send feedback.");
                            }
                          }}
                          className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg"
                        >
                          Send Feedback
                        </button>
                      </>
                    )}
                  </div>
                )}

                {/* Trainer Reply */}
                {userLessonQuestion && userLessonQuestion.length > 0 && (
                  <div className="mt-4 border-t pt-4">
                    <label className="block text-sm font-medium text-gray-700">Reply to question</label>
                    <textarea
                      value={trainerReply}
                      onChange={(e) => setTrainerReply(e.target.value)}
                      className="h-24 w-full border rounded-lg p-2"
                      placeholder="Write your answer..."
                      disabled={replyLoading}
                    />
                    <button
                      onClick={async () => {
                        if (!trainerReply.trim()) return alert("Answer cannot be empty.");
                        const qa = userLessonQuestion?.[0];
                        if (!qa) return alert("No question found.");
                        setReplyLoading(true);
                        try {
                          const payload = {
                            questionAnswerId: qa.id,
                            lessonId: selectedLesson?.id,
                            trainerReply,
                            trainerEmail: email,
                            avatarUrl,
                            trainerName: fullName || "Trainer",
                            createdAt: new Date().toISOString(),
                          };
                          await api.post("/api/trainer-question-answer/Update-answer-to-learning-content", payload);
                          await fetchUserLessonQuestion(selectedUser.userEmail, selectedLesson!.id);
                          setTrainerReply("");
                          alert("‚úÖ Trainer answer sent!");
                        } catch (err) {
                          console.error("‚ùå Reply failed:", err);
                          alert("Failed to send reply.");
                        } finally {
                          setReplyLoading(false);
                        }
                      }}
                      disabled={replyLoading || !trainerReply.trim()}
                      className={`mt-2 px-4 py-2 rounded-lg ${
                        replyLoading
                          ? "bg-gray-300 text-gray-500 cursor-not-allowed"
                          : "bg-green-600 text-white hover:bg-green-700"
                      }`}
                    >
                      {replyLoading ? "Sending..." : "Send Trainer Answer"}
                    </button>
                  </div>
                )}
              </div>
            )}
          </section>
        </div>
      </main>

      {showEditModal && selectedLesson && (
        <EditLessonModal
          open={showEditModal}
          initial={selectedLesson}
          onClose={() => setShowEditModal(false)}
          onSave={handleSaveLesson}
        />
      )}
    </div>
  );
};

export default AdminTaskManagementPage;
