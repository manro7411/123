package Testing;

import dto.CreateTeamRequestSimple;
import dto.TeamSummary;
import jakarta.inject.Inject;
import jakarta.persistence.EntityManager;
import jakarta.transaction.Transactional;
import jakarta.ws.rs.*;
import jakarta.ws.rs.core.MediaType;
import jakarta.ws.rs.core.Response;
import model.MemberEntity;
import model.TeamEntity;

import java.net.URI;
import java.util.*;
import java.util.stream.Collectors;

// ให้ตรงกับฝั่ง FE ที่เรียก /api/teams
@Path("/api/teams")
@Produces(MediaType.APPLICATION_JSON)
@Consumes(MediaType.APPLICATION_JSON)
public class TeamResource {

    @Inject
    EntityManager em;

    // ---------- Helpers ----------
    private static String genId() {
        return UUID.randomUUID().toString().replace("-", "").substring(0, 21);
    }

    private static TeamSummary toSummary(TeamEntity team) {
        String supervisorId = null;
        List<String> memberIds = new ArrayList<>();
        if (team.getMemberEntities() != null) {
            for (MemberEntity m : team.getMemberEntities()) {
                if (m == null) continue;
                if ("supervisor".equalsIgnoreCase(m.getRole())) {
                    supervisorId = m.getUserId(); // ใช้ field จริงใน MemberEntity
                } else {
                    memberIds.add(m.getUserId());
                }
            }
        }
        return new TeamSummary(team.getId(), team.getName(), supervisorId, memberIds);
    }

    // ---------- APIs ----------

    @GET
    public List<TeamSummary> getTeams() {
        List<TeamEntity> teams = em.createQuery(
                "SELECT DISTINCT t FROM TeamEntity t LEFT JOIN FETCH t.memberEntities",
                TeamEntity.class
        ).getResultList();
        return teams.stream().map(TeamResource::toSummary).toList();
    }

    @GET
    @Path("/{id}")
    public TeamSummary getTeam(@PathParam("id") String id) {
        TeamEntity team = em.find(TeamEntity.class, id);
        if (team == null) throw new NotFoundException("Team not found");
        team.getMemberEntities().size(); // ensure members loaded
        return toSummary(team);
    }

    // ดึงทีมที่ผู้ใช้คนหนึ่งสังกัด (รองรับอีเมลเป็น userId ได้)
    @GET
    @Path("/my-teams/{userId}")
    public List<TeamSummary> getTeamsByUserId(@PathParam("userId") String userId) {
        // ใช้ชื่อ field ที่มีจริงใน MemberEntity: userId (ไม่ใช่ userEmail)
        List<TeamEntity> teams = em.createQuery(
                "SELECT DISTINCT t FROM TeamEntity t " +
                        "JOIN t.memberEntities m " +
                        "LEFT JOIN FETCH t.memberEntities " +
                        "WHERE LOWER(m.userId) = LOWER(:uid)",
                TeamEntity.class
        ).setParameter("uid", userId).getResultList();

        return teams.stream().map(TeamResource::toSummary).toList();
    }

    // (สำรอง) เรียกแบบ query param ถ้ากังวล path ที่มี @
    @GET
    @Path("/my-teams")
    public List<TeamSummary> getTeamsByUserIdQuery(@QueryParam("userId") String userId) {
        if (userId == null || userId.isBlank()) throw new BadRequestException("userId is required");
        List<TeamEntity> teams = em.createQuery(
                "SELECT DISTINCT t FROM TeamEntity t " +
                        "JOIN t.memberEntities m " +
                        "LEFT JOIN FETCH t.memberEntities " +
                        "WHERE LOWER(m.userId) = LOWER(:uid)",
                TeamEntity.class
        ).setParameter("uid", userId).getResultList();

        return teams.stream().map(TeamResource::toSummary).toList();
    }

    @POST
    @Transactional
    public Response createTeam(CreateTeamRequestSimple request) {
        if (request == null || request.name == null || request.name.trim().isEmpty()) {
            throw new BadRequestException("Team name is required");
        }
        if (request.supervisorId == null || request.supervisorId.isBlank()) {
            throw new BadRequestException("supervisorId is required");
        }
        if (request.memberIds == null) {
            request.memberIds = List.of();
        }

        TeamEntity team = new TeamEntity();
        team.setId(genId());
        team.setName(request.name.trim());
        team.setDescription(request.description); // optional
        team.setCreateBy(request.createBy);       // optional
        team.setJoinCode(String.format("%06d", new Random().nextInt(1_000_000)));

        List<MemberEntity> members = new ArrayList<>();

        // เพิ่ม supervisor เข้าเป็นสมาชิกของทีมด้วย role = supervisor
        MemberEntity sup = new MemberEntity();
        sup.setId(genId());
        sup.setTeam(team);
        sup.setUserId(request.supervisorId); // ใช้ userId (field จริง)
        sup.setRole("supervisor");
        sup.setNameMembers(request.supervisorId); // ถ้ายังไม่มีชื่อจริง
        members.add(sup);

        // สมาชิกทั่วไป
        for (String mid : request.memberIds.stream().filter(Objects::nonNull).collect(Collectors.toSet())) {
            MemberEntity m = new MemberEntity();
            m.setId(genId());
            m.setTeam(team);
            m.setUserId(mid);
            m.setRole("member");
            m.setNameMembers(mid);
            members.add(m);
        }

        team.setMemberEntities(members);
        em.persist(team);

        return Response.created(URI.create("/api/teams/" + team.getId()))
                .entity(toSummary(team))
                .build();
    }

    @PUT
    @Path("/{id}")
    @Transactional
    public Response updateTeam(@PathParam("id") String id, TeamEntity updatedTeam) {
        TeamEntity team = em.find(TeamEntity.class, id);
        if (team == null) throw new NotFoundException("Team not found");

        if (updatedTeam.getName() != null) {
            team.setName(updatedTeam.getName());
        }
        if (updatedTeam.getDescription() != null) {
            team.setDescription(updatedTeam.getDescription());
        }

        team.getMemberEntities().size();
        return Response.ok(toSummary(team)).build();
    }

    @DELETE
    @Path("/{id}")
    @Transactional
    public Response deleteTeam(@PathParam("id") String id) {
        TeamEntity team = em.find(TeamEntity.class, id);
        if (team == null) throw new NotFoundException("Team not found");
        em.remove(team);
        return Response.noContent().build();
    }

    // --- จัดการสมาชิกในทีม: ใช้โดย Supervisor ตั้ง/ถอน Trainer ---

    @GET
    @Path("/{teamId}/members")
    public List<Map<String, Object>> getTeamMembers(@PathParam("teamId") String teamId) {
        TeamEntity team = em.find(TeamEntity.class, teamId);
        if (team == null) throw new NotFoundException("Team not found");
        team.getMemberEntities().size();

        List<Map<String, Object>> out = new ArrayList<>();
        for (MemberEntity m : team.getMemberEntities()) {
            Map<String, Object> row = new HashMap<>();
            row.put("userId", m.getUserId());
            row.put("name", m.getNameMembers());
            row.put("role", m.getRole()); // member | trainer | supervisor
            out.add(row);
        }
        return out;
    }

    @PUT
    @Path("/{teamId}/members/{userId}/role")
    @Transactional
    public Response setMemberRoleInTeam(
            @PathParam("teamId") String teamId,
            @PathParam("userId") String userId,
            Map<String, String> body
    ) {
        String role = Optional.ofNullable(body.get("role")).orElse("").toLowerCase(Locale.ROOT);
        if (!role.equals("trainer") && !role.equals("member")) {
            throw new BadRequestException("role must be 'trainer' or 'member'");
        }

        TeamEntity team = em.find(TeamEntity.class, teamId);
        if (team == null) throw new NotFoundException("Team not found");
        team.getMemberEntities().size();

        // TODO: เช็คสิทธิ์ว่า caller เป็น supervisor ของทีมนี้ (ขึ้นกับระบบ auth ของคุณ)

        MemberEntity target = team.getMemberEntities().stream()
                .filter(m -> m.getUserId() != null && m.getUserId().equalsIgnoreCase(userId))
                .findFirst()
                .orElseThrow(() -> new NotFoundException("Member not found in the team"));

        if ("supervisor".equalsIgnoreCase(target.getRole())) {
            throw new WebApplicationException("Cannot change supervisor role", 409);
        }

        target.setRole(role); // 'trainer' หรือ 'member'
        em.merge(target);

        // คืนรายการสมาชิกล่าสุดให้ FE
        return Response.ok(getTeamMembers(teamId)).build();
    }

    // -------- join by code (คงพฤติกรรมเดิม แต่ใช้ userId ให้ตรง entity) --------
    @POST
    @Path("/joining")
    @Transactional
    public Response joinTeamByCode(dto.CreateMemberRequest request) {
        if (request == null || request.joinCode == null || request.joinCode.trim().length() != 6) {
            throw new BadRequestException("Join code is invalid");
        }

        List<TeamEntity> teams = em.createQuery(
                "SELECT DISTINCT t FROM TeamEntity t LEFT JOIN FETCH t.memberEntities WHERE t.joinCode = :joinCode",
                TeamEntity.class
        ).setParameter("joinCode", request.joinCode).getResultList();

        if (teams.isEmpty()) {
            throw new BadRequestException("Join code is invalid");
        }

        TeamEntity team = teams.get(0);

        boolean alreadyExists = team.getMemberEntities().stream()
                .anyMatch(member -> member.getUserId() != null &&
                        member.getUserId().equalsIgnoreCase(request.userId));

        if (alreadyExists) {
            throw new WebApplicationException("User already in the team", 409);
        }

        MemberEntity member = new MemberEntity();
        member.setId(genId());
        member.setTeam(team);
        member.setUserId(request.userId);
        member.setRole(Optional.ofNullable(request.getRole()).orElse("member"));
        member.setNameMembers(Optional.ofNullable(request.userName).orElse(request.userId));
        team.getMemberEntities().add(member);

        em.persist(member);
        return Response.ok().entity(toSummary(team)).build();
    }
}
