package Testing;

import dto.CreateTeamRequestSimple;
import dto.TeamSummary;
import jakarta.inject.Inject;
import jakarta.persistence.EntityManager;
import jakarta.transaction.Transactional;
import jakarta.ws.rs.*;
import jakarta.ws.rs.core.MediaType;
import jakarta.ws.rs.core.Response;
import model.MemberEntity;
import model.TeamEntity;

import java.net.URI;
import java.util.*;
import java.util.stream.Collectors;

@Path("/teams") // << ให้ตรงกับ frontend
@Produces(MediaType.APPLICATION_JSON)
@Consumes(MediaType.APPLICATION_JSON)
public class TeamResource {

    @Inject
    EntityManager em;

    // ---------- Helpers ----------
    private static String genId() {
        return UUID.randomUUID().toString().replace("-", "").substring(0, 21);
    }

    private static TeamSummary toSummary(TeamEntity team) {
        // supervisor = สมาชิกที่ role = "supervisor"
        String supervisorId = null;
        List<String> memberIds = new ArrayList<>();
        if (team.getMemberEntities() != null) {
            for (MemberEntity m : team.getMemberEntities()) {
                if (m == null) continue;
                if ("supervisor".equalsIgnoreCase(m.getRole())) {
                    supervisorId = m.getUserEmail(); // เก็บเป็น userId/email ตามที่คุณใช้
                } else {
                    memberIds.add(m.getUserEmail());
                }
            }
        }
        return new TeamSummary(team.getId(), team.getName(), supervisorId, memberIds);
    }

    // ---------- APIs ----------

    @GET
    public List<TeamSummary> getTeams() {
        List<TeamEntity> teams = em.createQuery(
                "SELECT DISTINCT t FROM TeamEntity t LEFT JOIN FETCH t.memberEntities",
                TeamEntity.class
        ).getResultList();
        return teams.stream().map(TeamResource::toSummary).toList();
    }

    @GET
    @Path("/{id}")
    public TeamSummary getTeam(@PathParam("id") String id) {
        TeamEntity team = em.find(TeamEntity.class, id);
        if (team == null) throw new NotFoundException("Team not found");
        // ensure members loaded
        team.getMemberEntities().size();
        return toSummary(team);
    }

    @GET
    @Path("/my-teams/{userId}")
    public List<TeamSummary> getTeamsByUserId(@PathParam("userId") String userId) {
        // เดิมใช้ m.userID แต่ใน create/set ใช้ userEmail -> ให้ใช้ userEmail ให้ตรงกัน
        List<TeamEntity> teams = em.createQuery(
                        "SELECT DISTINCT m.team FROM MemberEntity m " +
                                "LEFT JOIN FETCH m.team.memberEntities " +
                                "WHERE LOWER(m.userEmail) = LOWER(:userId)",
                        TeamEntity.class
                ).setParameter("userId", userId)
                .getResultList();

        return teams.stream().map(TeamResource::toSummary).toList();
    }

    @POST
    @Transactional
    public Response createTeam(CreateTeamRequestSimple request) {
        if (request == null || request.name == null || request.name.trim().isEmpty()) {
            throw new BadRequestException("Team name is required");
        }
        if (request.supervisorId == null || request.supervisorId.isBlank()) {
            throw new BadRequestException("supervisorId is required");
        }
        if (request.memberIds == null) {
            request.memberIds = List.of();
        }

        TeamEntity team = new TeamEntity();
        team.setId(genId());
        team.setName(request.name.trim());
        team.setDescription(request.description); // optional
        team.setCreateBy(request.createBy);       // optional
        team.setJoinCode(String.format("%06d", new Random().nextInt(1_000_000)));

        // เตรียมสมาชิก: ใส่ supervisor เป็นสมาชิกด้วย role = "supervisor"
        List<MemberEntity> members = new ArrayList<>();

        MemberEntity sup = new MemberEntity();
        sup.setId(genId());
        sup.setTeam(team);
        sup.setUserEmail(request.supervisorId); // ใช้เป็น userId/email ให้สอดคล้องกับ frontend
        sup.setRole("supervisor");
        sup.setNameMembers(request.supervisorId); // ถ้ายังไม่มีชื่อจริง ใช้รหัสแทนไปก่อน
        members.add(sup);

        // ใส่สมาชิกทีมทั่วไป
        for (String mid : request.memberIds.stream().filter(Objects::nonNull).collect(Collectors.toSet())) {
            MemberEntity m = new MemberEntity();
            m.setId(genId());
            m.setTeam(team);
            m.setUserEmail(mid);
            m.setRole("member");
            m.setNameMembers(mid); // ถ้ามีชื่อจริง ค่อยอัปเดตภายหลัง
            members.add(m);
        }

        team.setMemberEntities(members);
        em.persist(team);

        return Response.created(URI.create("/api/teams/" + team.getId()))
                .entity(toSummary(team))
                .build();
    }

    @PUT
    @Path("/{id}")
    @Transactional
    public Response updateTeam(@PathParam("id") String id, TeamEntity updatedTeam) {
        TeamEntity team = em.find(TeamEntity.class, id);
        if (team == null) throw new NotFoundException("Team not found");

        if (updatedTeam.getName() != null) {
            team.setName(updatedTeam.getName());
        }
        if (updatedTeam.getDescription() != null) {
            team.setDescription(updatedTeam.getDescription());
        }

        // ส่งกลับเป็น TeamSummary เพื่อให้ frontend ใช้รูปแบบเดียวกัน
        team.getMemberEntities().size();
        return Response.ok(toSummary(team)).build();
    }

    @DELETE
    @Path("/{id}")
    @Transactional
    public Response deleteTeam(@PathParam("id") String id) {
        TeamEntity team = em.find(TeamEntity.class, id);
        if (team == null) throw new NotFoundException("Team not found");
        em.remove(team);
        return Response.noContent().build();
    }

    // -------- keep your existing join by code but align field names --------
    @POST
    @Path("/joining")
    @Transactional
    public Response joinTeamByCode(dto.CreateMemberRequest request) {
        if (request == null || request.joinCode == null || request.joinCode.trim().length() != 6) {
            throw new BadRequestException("Join code is invalid");
        }

        List<TeamEntity> teams = em.createQuery(
                "SELECT DISTINCT t FROM TeamEntity t LEFT JOIN FETCH t.memberEntities WHERE t.joinCode = :joinCode",
                TeamEntity.class
        ).setParameter("joinCode", request.joinCode).getResultList();

        if (teams.isEmpty()) {
            throw new BadRequestException("Join code is invalid");
        }

        TeamEntity team = teams.get(0);

        boolean alreadyExists = team.getMemberEntities()
                .stream()
                .anyMatch(member -> member.getUserEmail() != null &&
                        member.getUserEmail().equalsIgnoreCase(request.userId));

        if (alreadyExists) {
            throw new WebApplicationException("User already in the team", 409);
        }

        MemberEntity member = new MemberEntity();
        member.setId(genId());
        member.setTeam(team);
        member.setUserEmail(request.userId);
        member.setRole(Optional.ofNullable(request.getRole()).orElse("member"));
        member.setNameMembers(Optional.ofNullable(request.userName).orElse(request.userId));
        team.getMemberEntities().add(member);

        em.persist(member);
        return Response.ok().entity(toSummary(team)).build();
    }
}
