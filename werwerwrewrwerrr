
http://localhost:5173/api/posts
Request Method
POST
Status Code
401 Unauthorized
Remote Address
[::1]:5173
Referrer Policy
strict-origin-when-cross-origin
access-control-allow-credentials
true
access-control-allow-headers
accept,authorization,content-type,x-requested-with
access-control-allow-methods
GET,POST,PUT,DELETE,OPTIONS
access-control-allow-origin
http://localhost:5173
connection
close
content-length
0
date
Thu, 07 Aug 2025 09:12:36 GMT
vary
Origin
www-authenticate
Bearer
accept
*/*
accept-encoding
gzip, deflate, br, zstd
accept-language
en-US,en;q=0.9,th;q=0.8
authorization
Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJyb2xlIjoidXNlciIsInVwbiI6InJhdGNoYW5vbkBnbWFpbC5jb20iLCJlbWFpbCI6InJhdGNoYW5vbkBnbWFpbC5jb20iLCJuYW1lIjoiUmF0Y2hhbm9uIFRyYWl0aXByYXQiLCJpc3MiOiJodHRwczovL2V4YW1wbGUuY29tL2lzc3VlciIsInN1YiI6InJhdGNoYW5vbkBnbWFpbC5jb20iLCJncm91cHMiOlsidXNlciJdLCJpYXQiOjE3NTQ1NTA2NDEsImV4cCI6MTc1NDU1Nzg0MSwianRpIjoiNzU2NmM1MDctMGJlNi00NWViLWFmNjUtYmMxMzljOTRiZWNlIn0.PElaIP8iFYzoB9cf3m8DdhOA8YG6pySNYHvskwuDkipHZc1q1DoWYaBrlqMPJ1k4r2vA3g2TwB_hL-3j10oeuOU9ce4adqBTXrcwKy7_gjrjWUXXDWq0N6iSFGF_TMQpg-ldZebsmjxPwAsBUu0vzatDAurUGYOTQ4G8YtNuVY90pSyi_AtSKcQIdMX-MfX59Atf5Hj4sEFD0hToH_nYt3WX_KlD5ARL12KexUnNWnimvK-tfnUh07cKE6LidlBsVUHh529YQiHQf_GzPtWFOB0Q6ctioDPq6QDFBP2YXOH_N-6dC-cD7szmB-uWBO3XwHgF2Qm02GOenfJ8IHKisw
connection
keep-alive
content-length
293166
content-type
multipart/form-data; boundary=----WebKitFormBoundaryYKD2iukAvx9CFFFv
host
localhost:5173
origin
http://localhost:5173
referer
http://localhost:5173/forum
sec-ch-ua
"Not)A;Brand";v="8", "Chromium";v="138", "Microsoft Edge";v="138"
sec-ch-ua-mobile
?1
sec-ch-ua-platform
"Android"
sec-fetch-dest
empty
sec-fetch-mode
cors
sec-fetch-site
same-origin
user-agent
Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Mobile Safari/537.36 E
@POST
    @Transactional
    @RolesAllowed("user")
    @Consumes(MediaType.MULTIPART_FORM_DATA)
    @Produces(MediaType.APPLICATION_JSON)
    public Response create(@Valid PostCreateRequest req) {
        String email = identity.getPrincipal().getName();
        String displayName = Optional.ofNullable(req.authorName).filter(s -> !s.isBlank()).orElse(email);

        User user = em.createQuery("SELECT u FROM User u WHERE u.email = :email", User.class)
                .setParameter("email", email)
                .getSingleResult();

        PostEntity post = new PostEntity();
        post.setAuthorName(displayName);
        post.setAuthorEmail(email);
        post.setTitle(req.title);
        post.setMessage(req.message);
        post.setForumCategory(req.forumCategory);

        if (user.getAvatar() != null) {
            post.setAvatarUrl(user.getAvatar());
        }
        post.persist();
        String filename = post.getId() + ".jpg";
        if(req.picture != null){
            try {
                String originalName = req.pictureFileName != null ? req.pictureFileName : "picture.jpeg";
                java.nio.file.Path dir = java.nio.file.Paths.get("uploads/picture");
                java.nio.file.Files.createDirectories(dir);
                java.nio.file.Path picturePath = dir.resolve(filename);
                java.nio.file.Files.copy(req.picture, picturePath, StandardCopyOption.REPLACE_EXISTING);

                System.out.println("Picture path : " + picturePath.toString());
                System.out.println("Original file name: " + originalName);
                post.setPictureUrl("uploads/picture/" + filename);
            } catch (Exception e) {
                throw new InternalServerErrorException("Failed to save photo.");
            }
        }
        return Response.created(URI.create("/posts/" + post.getId()))
                .entity(post)
                .build();
    }
package Forum;
import jakarta.ws.rs.FormParam;
import org.jboss.resteasy.reactive.PartType;

import java.io.InputStream;

public class PostCreateRequest {

    @FormParam("title")

    public String title;

    @FormParam("message")

    public String message;

    @FormParam("authorName")

    public String authorName;

    @FormParam("forumCategory")

    public String forumCategory;

    @FormParam("picture")
    @PartType("application/octet-stream")

    public InputStream picture;

    @FormParam("pictureFileName")
    public String pictureFileName;
}
package Forum;

import com.aventrix.jnanoid.jnanoid.NanoIdUtils;
import io.quarkus.hibernate.orm.panache.PanacheEntityBase;
import jakarta.persistence.*;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Size;
import model.CommentEntity;

import java.time.LocalDateTime;
import java.util.HashSet;
import java.util.Set;

@Entity
@Table(name = "posts")
public class PostEntity extends PanacheEntityBase {
    @Id
    @Column(length = 21, nullable = false, updatable = false)
    private String id;

    @NotBlank
    @Size(max = 100)
    @Column(name = "author_name", nullable = false, length = 100)
    private String authorName;

    @NotBlank
    @Column(name = "author_email", nullable = false, length = 150)
    private String authorEmail;

    @NotBlank
    @Size(max = 255)
    private String title;

    @NotBlank
    @Column(nullable = false, columnDefinition = "TEXT")
    private String message;

    @Column(nullable = false)
    private long likes = 0;

    @Column(nullable = false)
    private long views = 0;

    @Column(name = "forum_category")
    private String forumCategory;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at")
    private LocalDateTime updatedAt;

    @Column(length = 512,name = "avatarurl")
    private String avatarUrl;

    @Transient
    private boolean likedByUser;

    @ElementCollection
    @CollectionTable(name = "post_likes", joinColumns = @JoinColumn(name = "post_id"))
    @Column(name = "user_email")
    private Set<String> likedBy = new HashSet<>();

    @Column(name = "pictureUrl")
    private String pictureUrl;


    @PrePersist
    void prePersist() {
        if (id == null || id.isBlank()) id = NanoIdUtils.randomNanoId();
        createdAt  = LocalDateTime.now();
        updatedAt  = createdAt;
    }

    @OneToMany(mappedBy = "post", cascade = CascadeType.ALL, orphanRemoval = true)
    private java.util.List<CommentEntity> comments = new java.util.ArrayList<>();


    @PreUpdate
    void preUpdate() { updatedAt = LocalDateTime.now(); }

    public String getId()            { return id; }
    public String getAuthorName()    { return authorName; }
    public String getAuthorEmail()   { return authorEmail; }
    public String getTitle()         { return title; }
    public String getMessage()       { return message; }
    public long   getLikes()         { return likes; }
    public long   getViews()         { return views; }
    public LocalDateTime getCreatedAt() { return createdAt; }
    public LocalDateTime getUpdatedAt() { return updatedAt; }
    public Set<String> getLikedBy() { return likedBy; }

    public void setAuthorName(String n)     { this.authorName = n; }
    public void setAuthorEmail(String e)    { this.authorEmail = e; }
    public void setTitle(String t)          { this.title = t; }
    public void setMessage(String m)        { this.message = m; }
    public void setLikes(long l)            { this.likes = l; }
    public void setViews(long v)            { this.views = v; }

    public String getAvatarUrl() {
        return avatarUrl;
    }

    public void setAvatarUrl(String avatarUrl) {
        this.avatarUrl = avatarUrl;
    }
    public void addLike(String email) {
        likedBy.add(email);
        this.likes = likedBy.size();
    }

    public void removeLike(String email) {
        likedBy.remove(email);
        this.likes = likedBy.size();
    }

    public boolean isLikedByUser() {
        return likedByUser;
    }

    public void setLikedByUser(boolean likedByUser) {
        this.likedByUser = likedByUser;
    }

    public String getForumCategory() {
        return forumCategory;
    }

    public void setForumCategory(String forumCategory) {
        this.forumCategory = forumCategory;
    }
    public String getPictureUrl() {
        return pictureUrl;
    }
    public void setPictureUrl(String pictureUrl) {
        this.pictureUrl = pictureUrl;
    }
}
