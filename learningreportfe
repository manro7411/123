package LearningReport.Resources;

import jakarta.annotation.security.RolesAllowed;
import jakarta.inject.Inject;
import jakarta.persistence.EntityManager;
import jakarta.ws.rs.*;
import jakarta.ws.rs.core.MediaType;
import jakarta.ws.rs.core.Response;
import model.MemberEntity;
import model.TeamEntity;
import model.User;
import model.UserLessonProgress;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.time.*;
import java.util.*;
import java.util.stream.Collectors;

@Path("/report/learning")
@RolesAllowed({"supervisor","administrator","admin"})
@Produces(MediaType.APPLICATION_JSON)
@Consumes(MediaType.APPLICATION_JSON)
public class SupervisorLearningReportResource {

    private static final Logger log = LoggerFactory.getLogger(SupervisorLearningReportResource.class);

    @Inject
    EntityManager entityManager;

    /**
     * GET /report/learning?teamId=...&start=YYYY-MM-DD&end=YYYY-MM-DD&userId=(optional)
     * - teamId: บังคับ
     * - start/end: ถ้าไม่ส่ง -> 7 วันล่าสุด
     * - userId: ถ้าส่ง -> กรองรายบุคคล (ระบุเป็น userId ที่อยู่ใน MemberEntity.memberId)
     */
    @GET
    public Response getReport(@QueryParam("teamId") String teamId,
                              @QueryParam("start") String startStr,
                              @QueryParam("end") String endStr,
                              @QueryParam("userId") String filterUserId) {

        log.info("Generating learning report for teamId={}, start={}, end={}, userId={}",
                teamId, startStr, endStr, filterUserId);

        if (isBlank(teamId)) {
            return Response.status(Response.Status.BAD_REQUEST).entity("teamId is required").build();
        }

        // ช่วงวัน
        LocalDate startDate = (isBlank(startStr)) ? LocalDate.now().minusDays(6) : LocalDate.parse(startStr);
        LocalDate endDate   = (isBlank(endStr))   ? LocalDate.now()              : LocalDate.parse(endStr);
        if (startDate.isAfter(endDate)) {
            return Response.status(Response.Status.BAD_REQUEST)
                    .entity("start date must be before or equal to end date").build();
        }
        LocalDateTime startAt = startDate.atStartOfDay();
        LocalDateTime endAt   = endDate.atTime(LocalTime.MAX);

        // ทีม + สมาชิก
        TeamEntity team = entityManager.find(TeamEntity.class, teamId);
        if (team == null) {
            return Response.status(Response.Status.NOT_FOUND).entity("Team not found: " + teamId).build();
        }
        team.getMemberEntities().size();

        List<MemberEntity> teamMembers = team.getMemberEntities().stream()
                .filter(m -> m != null && !isBlank(m.getMemberId()))
                .toList();

        // userId (จาก memberId) ทั้งหมดของทีม
        Set<String> memberIds = teamMembers.stream()
                .map(MemberEntity::getMemberId)
                .filter(Objects::nonNull)
                .map(String::trim)
                .filter(s -> !s.isEmpty())
                .map(String::toLowerCase)
                .collect(Collectors.toCollection(LinkedHashSet::new));

        // กรองรายบุคคลถ้าระบุ
        if (!isBlank(filterUserId)) {
            String target = filterUserId.trim().toLowerCase();
            if (!memberIds.contains(target)) {
                // ไม่ใช่สมาชิกทีม -> ส่งผลลัพธ์ว่างของทีมนั้น
                return Response.ok(emptyFor(team)).build();
            }
            memberIds = new LinkedHashSet<>(List.of(target));
        }

        if (memberIds.isEmpty()) {
            return Response.ok(emptyFor(team)).build();
        }

        // ดึง User เพื่อ map: userId (u.id) -> (email, name)
        List<User> users = entityManager.createQuery(
                        "SELECT u FROM User u WHERE LOWER(u.id) IN :ids", User.class)
                .setParameter("ids", memberIds)
                .getResultList();

        Map<String, String> userIdLower_to_emailLower = new HashMap<>();
        Map<String, String> emailLower_to_displayName = new HashMap<>();
        for (User u : users) {
            String idLower = safeLower(u.getId() != null ? u.getId().toString() : null);
            String emailLower = safeLower(u.getEmail());
            if (idLower != null && emailLower != null) {
                userIdLower_to_emailLower.put(idLower, emailLower);
            }
            if (emailLower != null && !isBlank(u.getName())) {
                emailLower_to_displayName.put(emailLower, u.getName());
            }
        }

        // เซ็ตอีเมลผู้ใช้ในทีม (lowercase)
        Set<String> memberEmails = memberIds.stream()
                .map(userIdLower_to_emailLower::get)
                .filter(Objects::nonNull)
                .collect(Collectors.toCollection(LinkedHashSet::new));

        if (memberEmails.isEmpty()) {
            return Response.ok(emptyFor(team)).build();
        }

        // Query progress ของคนในทีมภายในช่วง
        List<UserLessonProgress> progresses = entityManager.createQuery("""
            SELECT p FROM UserLessonProgress p
            WHERE LOWER(p.userEmail) IN :emails
              AND (
                   (p.updatedAt BETWEEN :startAt AND :endAt)
                OR (p.completedAt IS NOT NULL AND p.completedAt BETWEEN :startAt AND :endAt)
              )
            """, UserLessonProgress.class)
                .setParameter("emails", memberEmails)
                .setParameter("startAt", startAt)
                .setParameter("endAt", endAt)
                .getResultList();

        // group by userEmail (lower)
        Map<String, List<UserLessonProgress>> byUser = progresses.stream()
                .collect(Collectors.groupingBy(p -> safeLower(p.getUserEmail()),
                        LinkedHashMap::new, Collectors.toList()));

        // ประกอบรายงานรายบุคคล
        List<UserReportDto> userReports = new ArrayList<>();
        for (String emailLower : memberEmails) {
            List<UserLessonProgress> ups = byUser.getOrDefault(emailLower, List.of());

            // รวมโมดูลจาก lessonId ในช่วง
            int totalModules = (int) ups.stream()
                    .map(UserLessonProgress::getLessonId)
                    .filter(Objects::nonNull)
                    .map(String::trim)
                    .filter(s -> !s.isEmpty())
                    .distinct().count();

            // จำนวนที่จบ: percent == 100 และ completedAt อยู่ในช่วง
            int completedModules = (int) ups.stream()
                    .filter(p -> p.getPercent() != null && p.getPercent() == 100)
                    .filter(p -> p.getCompletedAt() == null ||
                            (!p.getCompletedAt().isAfter(endAt) && !p.getCompletedAt().isBefore(startAt)))
                    .map(UserLessonProgress::getLessonId)
                    .filter(Objects::nonNull)
                    .distinct().count();

            // คะแนนเฉลี่ย (เปอร์เซ็นต์)
            List<Integer> percs = ups.stream()
                    .filter(p -> p.getScore() != null && p.getTotalQuestions() != null && p.getTotalQuestions() > 0)
                    .map(p -> (int) Math.round(p.getScore() * 100.0 / p.getTotalQuestions()))
                    .toList();
            Integer avgScore = percs.isEmpty() ? null
                    : (int) Math.round(percs.stream().mapToInt(i -> i).average().orElse(0));

            // เวลาเรียนรวม (นาที) : screenTime สะสม / 60
            int timeSpentMinutes = ups.stream()
                    .map(UserLessonProgress::getScreenTime)
                    .filter(Objects::nonNull).mapToInt(Integer::intValue)
                    .sum() / 60;

            // กิจกรรมล่าสุด (updatedAt ล่าสุด)
            String lastActiveAt = ups.stream()
                    .map(UserLessonProgress::getUpdatedAt)
                    .filter(Objects::nonNull)
                    .max(Comparator.naturalOrder())
                    .map(LocalDateTime::toString)
                    .orElse(null);

            // รายโมดูล: เอา row ล่าสุดของแต่ละ lessonId
            List<UserModuleDetailDto> modules = ups.stream()
                    .collect(Collectors.groupingBy(p -> {
                        String lid = p.getLessonId();
                        return (lid == null) ? "" : lid.trim();
                    }))
                    .entrySet().stream()
                    .filter(e -> e.getKey() != null && !e.getKey().isBlank())
                    .map(e -> {
                        String lessonId = e.getKey();
                        List<UserLessonProgress> rows = e.getValue();

                        UserLessonProgress latest = rows.stream()
                                .max(Comparator.comparing(UserLessonProgress::getUpdatedAt, Comparator.nullsFirst(Comparator.naturalOrder())))
                                .orElse(rows.get(0));

                        UserModuleDetailDto md = new UserModuleDetailDto();
                        md.moduleId = lessonId;
                        md.moduleTitle = "Lesson " + lessonId; // ถ้ามี LearningContent สามารถ lookup ชื่อจริงมาวางได้
                        // สถานะ: ใช้ field status ถ้ามี, ไม่มีก็ derive จาก percent
                        md.status = (latest.getStatus() != null) ? latest.getStatus()
                                : (latest.getPercent() != null && latest.getPercent() >= 100) ? "completed"
                                : (latest.getPercent() != null && latest.getPercent() > 0) ? "in-progress" : "not_started";
                        md.score = latest.getScore();
                        md.totalQuestions = latest.getTotalQuestions();
                        md.timeSpentMinutes = Optional.ofNullable(latest.getScreenTime()).orElse(0) / 60;
                        md.lastActiveAt = latest.getUpdatedAt() != null ? latest.getUpdatedAt().toString() : null;
                        return md;
                    })
                    .sorted(Comparator.comparing(m -> m.moduleId))
                    .toList();

            // รายวัน: ใช้ completedAt นับจำนวน “จบ” ต่อวัน
            Map<LocalDate, Integer> completedByDay = new LinkedHashMap<>();
            for (LocalDate d = startDate; !d.isAfter(endDate); d = d.plusDays(1)) {
                completedByDay.put(d, 0);
            }
            ups.stream().filter(p -> p.getCompletedAt() != null).forEach(p -> {
                LocalDate d = p.getCompletedAt().toLocalDate();
                if (!d.isBefore(startDate) && !d.isAfter(endDate)) {
                    completedByDay.computeIfPresent(d, (k, v) -> v + 1);
                }
            });
            List<UserDailyProgressDto> daily = completedByDay.entrySet().stream().map(e -> {
                UserDailyProgressDto dd = new UserDailyProgressDto();
                dd.date = e.getKey().toString();
                dd.completed = e.getValue();
                dd.minutes = 0;      // ไม่มี daily time แท้
                dd.scoreAvg = null;  // ไม่มี daily avg score แยกวัน
                return dd;
            }).toList();

            // ชื่อแสดงผล (จาก User.name)
            String displayName = emailLower_to_displayName.getOrDefault(emailLower, null);

            UserLearningSummary summary = new UserLearningSummary();
            summary.userId = emailLower; // เก็บเป็นอีเมล (lower)
            summary.name = displayName;
            summary.totalModules = totalModules;
            summary.completedModules = completedModules;
            summary.avgScore = avgScore;
            summary.timeSpentMinutes = timeSpentMinutes;
            summary.lastActiveAt = lastActiveAt;

            UserReportDto ur = new UserReportDto();
            ur.summary = summary;
            ur.daily = daily;
            ur.modules = modules;

            userReports.add(ur);
        }

        // Team summary
        TeamSummaryDto teamSummary = new TeamSummaryDto();
        teamSummary.teamId = team.getId();
        teamSummary.teamName = team.getName();
        teamSummary.totalLearners = userReports.size();

        double sumRates = 0.0;
        int cntRates = 0;
        for (UserReportDto ur : userReports) {
            if (ur.summary.totalModules > 0) {
                sumRates += (ur.summary.completedModules * 1.0 / ur.summary.totalModules);
                cntRates++;
            }
        }
        teamSummary.avgCompletionRate = (cntRates == 0) ? 0.0 : (sumRates / cntRates);

        List<Integer> teamScores = userReports.stream()
                .map(u -> u.summary.avgScore)
                .filter(Objects::nonNull)
                .toList();
        teamSummary.avgScore = teamScores.isEmpty() ? null
                : (int) Math.round(teamScores.stream().mapToInt(i -> i).average().orElse(0));

        teamSummary.totalTimeSpentMinutes = userReports.stream()
                .map(u -> u.summary.timeSpentMinutes)
                .reduce(0, Integer::sum);

        LearningReportDto dto = new LearningReportDto();
        dto.teamSummary = teamSummary;
        dto.users = userReports;

        return Response.ok(dto).build();
    }

    // ----------------- DTOs -----------------

    public static class LearningReportDto {
        public TeamSummaryDto teamSummary;
        public List<UserReportDto> users;
    }

    public static class TeamSummaryDto {
        public String teamId;
        public String teamName;
        public int totalLearners;
        public double avgCompletionRate; // 0..1
        public Integer avgScore;         // 0..100, null ถ้าไม่มีข้อมูล
        public int totalTimeSpentMinutes;
    }

    public static class UserReportDto {
        public UserLearningSummary summary;
        public List<UserDailyProgressDto> daily;
        public List<UserModuleDetailDto> modules;
    }

    public static class UserLearningSummary {
        public String userId;             // อีเมล (lower)
        public String name;               // แสดงผล
        public int totalModules;
        public int completedModules;
        public Integer avgScore;          // 0..100 หรือ null
        public int timeSpentMinutes;
        public String lastActiveAt;       // ISO string
    }

    public static class UserDailyProgressDto {
        public String date;               // YYYY-MM-DD
        public int completed;             // จำนวนโมดูลที่จบในวันนั้น
        public int minutes;               // ไม่มีข้อมูลรายวัน -> 0
        public Integer scoreAvg;          // ไม่มีข้อมูลรายวัน -> null
    }

    public static class UserModuleDetailDto {
        public String moduleId;
        public String moduleTitle;
        public String status;             // not_started | in-progress | completed
        public Integer score;             // raw score
        public Integer totalQuestions;
        public int timeSpentMinutes;
        public String lastActiveAt;
    }

    // ----------------- Helpers -----------------

    private static boolean isBlank(String s) {
        return s == null || s.isBlank();
    }

    private static String safeLower(String s) {
        return (s == null) ? null : s.toLowerCase();
    }

    private LearningReportDto emptyFor(TeamEntity team) {
        LearningReportDto dto = new LearningReportDto();
        TeamSummaryDto ts = new TeamSummaryDto();
        ts.teamId = team.getId();
        ts.teamName = team.getName();
        ts.totalLearners = 0;
        ts.avgCompletionRate = 0.0;
        ts.avgScore = null;
        ts.totalTimeSpentMinutes = 0;
        dto.teamSummary = ts;
        dto.users = List.of();
        return dto;
    }
}
------
import { useContext, useEffect, useMemo, useState } from "react";
import axios from "axios";
import SupervisorSidebarWidget from "../Widgets/SupervisorSideBar";
import { Download, Filter, RefreshCw } from "lucide-react";
import {
  LineChart,
  Line,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  BarChart,
  Bar,
  Legend,
} from "recharts";
import { useUserProfile } from "../../Lesson/hooks/useUserProfile";
import { AuthContext } from "../../../Authentication/AuthContext";

// ----------------------
// Axios instance
// ----------------------
const axiosClient = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL || "/",
});
axiosClient.interceptors.request.use((config) => {
  const token = localStorage.getItem("token") || sessionStorage.getItem("token");
  if (token) {
    config.headers = { ...(config.headers || {}), Authorization: `Bearer ${token}` };
  }
  return config;
});

// ----------------------
// Types (สอดคล้อง DTO ของ /report/learning)
// ----------------------
export type Team = { id: string; name: string; supervisorId?: string | null; memberIds?: string[] };
export type TeamMember = { userId: string; name?: string; role: string };

export type UserLearningSummary = {
  userId: string;            // backend คืนเป็น “อีเมล (lowercase)”
  name?: string | null;
  totalModules: number;
  completedModules: number;
  avgScore: number | null;   // 0..100
  timeSpentMinutes: number;  // minutes
  lastActiveAt?: string | null; // ISO
};

export type UserDailyProgress = {
  date: string;              // YYYY-MM-DD
  completed: number;
  minutes: number;
  scoreAvg: number | null;
};

export type UserModuleDetail = {
  moduleId: string;
  moduleTitle: string;
  status: "not_started" | "in-progress" | "completed";
  score: number | null;
  totalQuestions?: number | null;
  timeSpentMinutes: number;
  lastActiveAt?: string | null;
};

export type LearningReportPayload = {
  teamSummary: {
    teamId: string;
    teamName: string;
    totalLearners: number;
    avgCompletionRate: number;  // 0..1
    avgScore: number | null;    // 0..100
    totalTimeSpentMinutes: number;
  };
  users: Array<{
    summary: UserLearningSummary;
    daily: UserDailyProgress[];
    modules: UserModuleDetail[];
  }>;
};

// ----------------------
// Helpers
// ----------------------
function formatMinutes(min: number) {
  const h = Math.floor(min / 60);
  const m = min % 60;
  if (h <= 0) return `${m}m`;
  if (m <= 0) return `${h}h`;
  return `${h}h ${m}m`;
}

// JWT helper เพื่อหาผู้ใช้ปัจจุบัน (email/userId) จาก token หรือ /api/profile
function parseJwt(token: string | null): any | null {
  if (!token) return null;
  const parts = token.split(".");
  if (parts.length !== 3) return null;
  try {
    const payload = JSON.parse(atob(parts[1].replace(/-/g, "+").replace(/_/g, "/")));
    return payload;
  } catch {
    return null;
  }
}

async function resolveCurrentUserId(): Promise<string | null> {
  const cached = localStorage.getItem("userId") || sessionStorage.getItem("userId");
  if (cached) return cached;
  const token = localStorage.getItem("token") || sessionStorage.getItem("token");
  const payload = parseJwt(token);
  const jwtId = payload?.sub || payload?.userId || payload?.email || null;
  if (jwtId) return String(jwtId);
  try {
    const { data } = await axiosClient.get<any>("/api/profile");
    return data?.id || data?.userId || data?.email || null;
  } catch {
    return null;
  }
}

// ----------------------
// Main Component (เชื่อมต่อ Backend จริง)
// ----------------------
export default function Svplearningreport() {

    const { token: ctxToken } = useContext(AuthContext);
    const token = ctxToken || localStorage.getItem("token") || sessionStorage.getItem("token");
  // filters
  const [teams, setTeams] = useState<Team[]>([]);
  const [selectedTeamId, setSelectedTeamId] = useState<string>("");
  const [members, setMembers] = useState<TeamMember[]>([]);
  const [selectedUserId, setSelectedUserId] = useState<string | null>(null);

  // date range: default 7 วันล่าสุด
  const today = useMemo(() => new Date(), []);
  const weekAgo = useMemo(() => new Date(Date.now() - 6 * 24 * 3600 * 1000), []);
  const toDateInput = (d: Date) => d.toISOString().slice(0, 10);
  const [startDate, setStartDate] = useState(toDateInput(weekAgo));
  const [endDate, setEndDate] = useState(toDateInput(today));

  // data
  const [report, setReport] = useState<LearningReportPayload | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [booting, setBooting] = useState(true);
  const {userId} = useUserProfile(token);
  

  // โหลดทีมของฉัน
  // useEffect(() => {
  //   (async () => {
  //     setBooting(true);
  //     setError(null);
  //     try {
  //       const uid = await resolveCurrentUserId();
  //       if (!uid) {
  //         setError("ไม่พบผู้ใช้ปัจจุบัน (userId) — ตรวจสอบโทเคน/การเข้าสู่ระบบ");
  //         setBooting(false);
  //         return;
  //       }
  //       // แก้ path ให้ตรง backend ของคุณ (มีทั้ง /api/teams/my-teams?userId=...)
  //       const { data } = await axiosClient.get<Team[]>("/api/teams/my-teams", { params: { userId: uid } });
  //       setTeams(data || []);
  //       if (data?.length) {
  //         setSelectedTeamId(data[0].id);
  //       } else {
  //         setSelectedTeamId("");
  //       }
  //     } catch (e: any) {
  //       setError(e?.response?.data?.message || "โหลดทีมไม่สำเร็จ");
  //     } finally {
  //       setBooting(false);
  //     }
  //   })();
  // }, []);
  useEffect(() => {
  if (!userId) return; // รอจนกว่าจะได้ userId จาก useUserProfile
  setBooting(true);
  setError(null);
  axiosClient
    .get<Team[]>("/api/teams/my-teams", { params: { userId } })
    .then(({ data }) => {
      setTeams(data || []);
      if (data?.length) {
        setSelectedTeamId(data[0].id);
      } else {
        setSelectedTeamId("");
      }
    })
    .catch((e: any) => {
      setError(e?.response?.data?.message || "โหลดทีมไม่สำเร็จ");
    })
    .finally(() => setBooting(false));
  }, [userId]);

  // เมื่อเปลี่ยนทีม -> โหลดสมาชิก
  useEffect(() => {
    (async () => {
      if (!selectedTeamId) {
        setMembers([]);
        setSelectedUserId(null);
        setReport(null);
        return;
      }
      setError(null);
      try {
        const { data } = await axiosClient.get<TeamMember[]>(`/api/teams/${selectedTeamId}/members`, {
          params: { order: "roleThenJoined" },
        });
        // backend คืน TeamMemberDTO = { userId, name, role }
        setMembers(data || []);
        // reset ถ้า user เดิมไม่อยู่
        setSelectedUserId((prev) => (prev && (data || []).some((m: TeamMember) => m.userId === prev)) ? prev : null);
      } catch (e: any) {
        setMembers([]);
        setSelectedUserId(null);
        setError(e?.response?.data?.message || "โหลดสมาชิกทีมไม่สำเร็จ");
      }
    })();
  }, [selectedTeamId]);

  // โหลดรายงานครั้งแรก (หลังมีทีม)
  useEffect(() => {
    if (!selectedTeamId) return;
    fetchReport();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [selectedTeamId]);

  // เรียก backend report
  const fetchReport = async () => {
    if (!selectedTeamId) return;
    setLoading(true);
    setError(null);
    try {
      const params: any = {
        teamId: selectedTeamId,
        start: startDate,
        end: endDate,
      };
      if (selectedUserId) params.userId = selectedUserId; // *** หมายเหตุ: backend คาดหวัง userId (ค่าที่เก็บใน memberId) ***

      // แก้ path ให้ตรงกับ resource ของคุณ (ตัวอย่างนี้ใช้ /report/learning ตามที่เราสร้าง)
      const { data } = await axiosClient.get<LearningReportPayload>("/report/learning", { params });
      setReport(data || null);
    } catch (e: any) {
      setReport(null);
      setError(e?.response?.data || e?.message || "โหลดรายงานไม่สำเร็จ");
    } finally {
      setLoading(false);
    }
  };

  const teamSummary = report?.teamSummary || null;
  const users = report?.users || [];
  const selectedUser = useMemo(
    () => users.find((u) => u.summary.userId === (selectedUserId ?? "")) || null,
    [users, selectedUserId]
  );

  // export helpers
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  function downloadCsv(filename: string, rows: Array<Record<string, any>>) {
    if (!rows?.length) return;
    const head = Object.keys(rows[0]);
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    const escape = (val: any) => typeof val === "string" ? `"${val.replace(/"/g, '""')}"` : (val ?? "");
    const csv = [head.join(",")].concat(rows.map(r => head.map(k => escape(r[k])).join(","))).join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
  }

  const exportTeamCsv = () => {
    const rows = users.map(u => ({
      userId: u.summary.userId,
      name: u.summary.name || "",
      totalModules: u.summary.totalModules,
      completedModules: u.summary.completedModules,
      completionRate: u.summary.totalModules ? (u.summary.completedModules / u.summary.totalModules) : 0,
      avgScore: u.summary.avgScore ?? "",
      timeSpentMinutes: u.summary.timeSpentMinutes,
      lastActiveAt: u.summary.lastActiveAt || "",
    }));
    downloadCsv(`team-learning-${selectedTeamId}.csv`, rows);
  };

  const exportUserModulesCsv = () => {
    if (!selectedUser) return;
    const rows = selectedUser.modules.map(m => ({
      moduleId: m.moduleId,
      moduleTitle: m.moduleTitle,
      status: m.status,
      score: m.score ?? "",
      totalQuestions: m.totalQuestions ?? "",
      timeSpentMinutes: m.timeSpentMinutes,
      lastActiveAt: m.lastActiveAt || "",
    }));
    downloadCsv(`user-modules-${selectedUser.summary.userId}.csv`, rows);
  };

  return (
    <div className="flex h-screen bg-gray-50">
      <SupervisorSidebarWidget />

      <div className="flex-1 p-6 md:p-8 overflow-y-auto space-y-6">
        {/* Header */}
        <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <h1 className="text-2xl md:text-3xl font-bold">Learning Report</h1>
          <div className="flex gap-2">
            <button
              className="inline-flex items-center gap-2 rounded-xl border px-3 py-2 bg-white hover:bg-gray-50"
              onClick={fetchReport}
              disabled={loading || !selectedTeamId}
              title="Refresh"
            >
              <RefreshCw className="w-4 h-4" /> รีเฟรช
            </button>
            <button
              className="inline-flex items-center gap-2 rounded-xl border px-3 py-2 bg-white hover:bg-gray-50"
              onClick={exportTeamCsv}
              disabled={!users.length}
              title="Export team CSV"
            >
              <Download className="w-4 h-4" /> ส่งออกทีม (CSV)
            </button>
            {selectedUser && (
              <button
                className="inline-flex items-center gap-2 rounded-xl border px-3 py-2 bg-white hover:bg-gray-50"
                onClick={exportUserModulesCsv}
                title="Export user CSV"
              >
                <Download className="w-4 h-4" /> ส่งออกบุคคล (CSV)
              </button>
            )}
          </div>
        </div>

        {/* Filters */}
        <div className="rounded-2xl border bg-white p-4">
          <div className="flex items-center gap-2 mb-4">
            <Filter className="w-4 h-4" />
            <div className="font-semibold">ตัวกรองรายงาน</div>
          </div>

          {/* เลือกทีม/สมาชิก/ช่วงวัน */}
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            {/* Team */}
            <div className="space-y-1">
              <div className="text-xs uppercase opacity-60">ทีม</div>
              <select
                className="w-full rounded-xl border px-3 py-2 bg-white"
                value={selectedTeamId}
                onChange={(e) => setSelectedTeamId(e.target.value)}
                disabled={booting}
              >
                {!teams.length && <option value="">— ไม่มีทีม —</option>}
                {teams.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
              </select>
            </div>

            {/* User */}
            <div className="space-y-1">
              <div className="text-xs uppercase opacity-60">สมาชิก</div>
              <select
                className="w-full rounded-xl border px-3 py-2 bg-white"
                value={selectedUserId || ""}
                onChange={(e) => setSelectedUserId(e.target.value || null)}
                disabled={!members.length}
              >
                <option value="">— ทั้งทีม —</option>
                {members.map(m => (
                  <option key={m.userId} value={m.userId}>{m.name || m.userId}</option>
                ))}
              </select>
            </div>

            {/* Date range */}
            <div className="space-y-1">
              <div className="text-xs uppercase opacity-60">เริ่ม</div>
              <input
                type="date"
                className="w-full rounded-xl border px-3 py-2 bg-white"
                value={startDate}
                onChange={(e) => setStartDate(e.target.value)}
              />
            </div>
            <div className="space-y-1">
              <div className="text-xs uppercase opacity-60">สิ้นสุด</div>
              <input
                type="date"
                className="w-full rounded-xl border px-3 py-2 bg-white"
                value={endDate}
                onChange={(e) => setEndDate(e.target.value)}
              />
            </div>
          </div>

          <div className="mt-4">
            <button
              className="rounded-xl px-4 py-2 border bg-blue-600 text-white hover:opacity-90"
              onClick={fetchReport}
              disabled={loading || !selectedTeamId}
            >
              {loading ? "กำลังโหลด..." : "ดูรายงาน"}
            </button>
          </div>
        </div>

        {/* Errors */}
        {error && (
          <div className="rounded-2xl border border-red-200 bg-red-50 p-3 text-red-700">{String(error)}</div>
        )}

        {/* Team Summary */}
        {teamSummary && (
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div className="rounded-2xl border bg-white p-4">
              <div className="text-xs uppercase opacity-60">ผู้เรียน</div>
              <div className="text-2xl font-bold">{teamSummary.totalLearners}</div>
            </div>
            <div className="rounded-2xl border bg-white p-4">
              <div className="text-xs uppercase opacity-60">อัตราเรียนจบเฉลี่ย</div>
              <div className="text-2xl font-bold">{Math.round(teamSummary.avgCompletionRate * 100)}%</div>
            </div>
            <div className="rounded-2xl border bg-white p-4">
              <div className="text-xs uppercase opacity-60">คะแนนเฉลี่ย</div>
              <div className="text-2xl font-bold">{teamSummary.avgScore ?? "-"}</div>
            </div>
            <div className="rounded-2xl border bg-white p-4">
              <div className="text-xs uppercase opacity-60">เวลาที่ใช้รวม</div>
              <div className="text-2xl font-bold">{formatMinutes(teamSummary.totalTimeSpentMinutes)}</div>
            </div>
          </div>
        )}

        {/* Team table */}
        {!!users.length && (
          <div className="rounded-2xl border bg-white p-4">
            <div className="mb-3 flex items-center justify-between">
              <div className="font-semibold">สรุปรายบุคคล</div>
              <div className="text-sm opacity-60">ช่วง {startDate} → {endDate}</div>
            </div>
            <div className="overflow-auto">
              <table className="min-w-full text-sm">
                <thead>
                  <tr className="text-left border-b">
                    <th className="px-3 py-2">ผู้เรียน</th>
                    <th className="px-3 py-2">เรียนจบ / ทั้งหมด</th>
                    <th className="px-3 py-2">อัตราเรียนจบ</th>
                    <th className="px-3 py-2">คะแนนเฉลี่ย</th>
                    <th className="px-3 py-2">เวลาเรียนรวม</th>
                    <th className="px-3 py-2">Active ล่าสุด</th>
                    <th className="px-3 py-2">ดู</th>
                  </tr>
                </thead>
                <tbody>
                  {users.map((u) => {
                    const rate = u.summary.totalModules ? (u.summary.completedModules / u.summary.totalModules) : 0;
                    return (
                      <tr key={u.summary.userId} className="border-b hover:bg-gray-50">
                        <td className="px-3 py-2 whitespace-nowrap">{u.summary.name || u.summary.userId}</td>
                        <td className="px-3 py-2">{u.summary.completedModules} / {u.summary.totalModules}</td>
                        <td className="px-3 py-2">{Math.round(rate * 100)}%</td>
                        <td className="px-3 py-2">{u.summary.avgScore ?? "-"}</td>
                        <td className="px-3 py-2">{formatMinutes(u.summary.timeSpentMinutes)}</td>
                        <td className="px-3 py-2">{u.summary.lastActiveAt ? new Date(u.summary.lastActiveAt).toLocaleString() : "-"}</td>
                        <td className="px-3 py-2">
                          <button
                            className={`rounded-lg border px-2 py-1 ${selectedUserId === u.summary.userId ? 'bg-black text-white' : 'bg-white'}`}
                            onClick={() => setSelectedUserId(u.summary.userId)}
                          >
                            ดูรายคน
                          </button>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* Individual detail */}
        {selectedUser && (
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
            {/* Left: Metrics + Modules */}
            <div className="lg:col-span-1 space-y-4">
              <div className="rounded-2xl border bg-white p-4">
                <div className="font-semibold mb-2">สรุปบุคคล</div>
                <div className="space-y-2 text-sm">
                  <div className="flex justify-between"><span>ผู้เรียน</span><span>{selectedUser.summary.name || selectedUser.summary.userId}</span></div>
                  <div className="flex justify-between"><span>เรียนจบ/ทั้งหมด</span><span>{selectedUser.summary.completedModules}/{selectedUser.summary.totalModules}</span></div>
                  <div className="flex justify-between"><span>อัตราเรียนจบ</span><span>{selectedUser.summary.totalModules ? Math.round(selectedUser.summary.completedModules/selectedUser.summary.totalModules*100) : 0}%</span></div>
                  <div className="flex justify-between"><span>คะแนนเฉลี่ย</span><span>{selectedUser.summary.avgScore ?? '-'}</span></div>
                  <div className="flex justify-between"><span>เวลาเรียนรวม</span><span>{formatMinutes(selectedUser.summary.timeSpentMinutes)}</span></div>
                  <div className="flex justify-between"><span>Active ล่าสุด</span><span>{selectedUser.summary.lastActiveAt ? new Date(selectedUser.summary.lastActiveAt).toLocaleString() : '-'}</span></div>
                </div>
              </div>

              <div className="rounded-2xl border bg-white p-4">
                <div className="flex items-center justify-between mb-2">
                  <div className="font-semibold">โมดูลของบุคคล</div>
                  <button className="rounded-lg border px-2 py-1" onClick={exportUserModulesCsv}><Download className="w-4 h-4" /></button>
                </div>
                <div className="max-h-[28rem] overflow-auto text-sm">
                  <table className="min-w-full">
                    <thead>
                      <tr className="text-left border-b">
                        <th className="px-2 py-2">โมดูล</th>
                        <th className="px-2 py-2">สถานะ</th>
                        <th className="px-2 py-2">คะแนน</th>
                        <th className="px-2 py-2">เวลา</th>
                      </tr>
                    </thead>
                    <tbody>
                      {selectedUser.modules.map(m => (
                        <tr key={m.moduleId} className="border-b">
                          <td className="px-2 py-2">{m.moduleTitle}</td>
                          <td className="px-2 py-2 capitalize">{m.status.replace('_',' ')}</td>
                          <td className="px-2 py-2">{m.score ?? '-'}</td>
                          <td className="px-2 py-2">{formatMinutes(m.timeSpentMinutes)}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            {/* Right: Charts */}
            <div className="lg:col-span-2 space-y-4">
              <div className="rounded-2xl border bg-white p-4">
                <div className="font-semibold mb-2">ความคืบหน้ารายวัน (Completed)</div>
                <div className="h-64">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={selectedUser.daily}>
                      <XAxis dataKey="date" />
                      <YAxis allowDecimals={false} />
                      <Tooltip />
                      <Legend />
                      <Bar dataKey="completed" name="Completed" />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </div>

              <div className="rounded-2xl border bg-white p-4">
                <div className="font-semibold mb-2">เวลาเรียนรายวัน (นาที) & คะแนนเฉลี่ย</div>
                <div className="h-64">
                  <ResponsiveContainer width="100%" height="100%">
                    <LineChart data={selectedUser.daily}>
                      <XAxis dataKey="date" />
                      <YAxis yAxisId="left" />
                      <YAxis yAxisId="right" orientation="right" />
                      <Tooltip />
                      <Legend />
                      <Line type="monotone" dataKey="minutes" name="Minutes" yAxisId="left" />
                      <Line type="monotone" dataKey="scoreAvg" name="Avg Score" yAxisId="right" />
                    </LineChart>
                  </ResponsiveContainer>
                </div>
              </div>
            </div>
          </div>
        )}

        {!loading && !teamSummary && !error && (
          <div className="text-sm opacity-70">เลือกทีม, ช่วงเวลา แล้วกด "ดูรายงาน"</div>
        )}
      </div>
    </div>
  );
}
---

http://localhost:5173/report/learning?teamId=05486106b46642f79c627&start=2025-10-08&end=2025-10-14
Request Method
GET
Status Code
304 Not Modified
Remote Address
[::1]:5173
Referrer Policy
strict-origin-when-cross-origin
connection
keep-alive
date
Tue, 14 Oct 2025 07:40:49 GMT
keep-alive
timeout=5
vary
Origin
accept
application/json, text/plain, */*
accept-encoding
gzip, deflate, br, zstd
accept-language
en-US,en;q=0.9,th;q=0.8
authorization
Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJyb2xlIjoic3VwZXJ2aXNvciIsInVwbiI6InN2cEBnbWFpbC5jb20iLCJlbWFpbCI6InN2cEBnbWFpbC5jb20iLCJuYW1lIjoiUmF0Y2hhbm9uIFNWUCIsImlzcyI6Imh0dHBzOi8vZXhhbXBsZS5jb20vaXNzdWVyIiwic3ViIjoic3ZwQGdtYWlsLmNvbSIsImdyb3VwcyI6WyJzdXBlcnZpc29yIl0sImlhdCI6MTc2MDQyNzQ3MSwiZXhwIjoxNzYwNDM0NjcxLCJqdGkiOiI4MGVkOWZiZi1hZGI0LTQ5YzAtYjUwMy1mMzJhZTcwYTFlZDMifQ.ZxZDv0cCcCVHLlQc1x9b4nrWPEg8TLm23CdT5N_Zz-BiIGK5uXj6Uz_4faQAGjQ1apGDXV6BqiSGx8TLIvWyh-92YqXV09eMXyxGC7OaE0kaVgPDbA-2JjZS04YLgyIIzIlfBTSFU8_OUcTNENaKqf5j7118QNPFdr3KK4n_yoUs9AQwTEQIfSIH7TEmbFQPLweEVcqJfrA-nHxCQj9Ozyg3C7_ECfi1T1ojJ5OLAxTmdOrt_I0bXzk3UYxagFyhhxGGX0P6tynqxl8_sWKVUxYskgkr4w8rcdd8E2_Rlo9Py3rtrBq8anLkRRiO1mSlISXhw8geKGfu1v-M5ZhlZg
connection
keep-alive
host
localhost:5173
if-none-match
W/"369-YYb/idw0gYPEKQGOli31UNgaEcU"
referer
http://localhost:5173/supervisor/learning-report
sec-ch-ua
"Chromium";v="140", "Not=A?Brand";v="24", "Microsoft Edge";v="140"
sec-ch-ua-mobile
?0
sec-ch-ua-platform
"Windows"
sec-fetch-dest
empty
sec-fetch-mode
cors
sec-fetch-site
same-origin
user-agent
Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/140.0.0.0 Safari/537.36 Edg/140.0.0.0
